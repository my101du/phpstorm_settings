<templateSet group="user">
  <template name="t-c-tabs" value="$ctabs-&gt;addTab('All TR', 'tab_browse');&#10;$ctabs-&gt;addTab('My TR', 'tab_my');&#10;$ctabs-&gt;addTab('Details', 'tab_detail');&#10;$ctabs-&gt;addTab('Samples', 'tab_sample');&#10;$ctabs-&gt;setMainDivId('mainTabsDiv');&#10;$ctabs-&gt;setContentDivId('tab_browse_div');" description="创建 tabs" toReformat="true" toShortenFQNames="true">
    <context>
      <option name="PHP Expression" value="true" />
      <option name="PHP Statement" value="true" />
    </context>
  </template>
  <template name="t-c-updateForm" value="public function updateDataJsonForm($mockFormData = null)&#10;{&#10;    if (isset($_POST['upd'])) {&#10;        $upd_array      = json_decode($_POST['upd']);&#10;        $additionalData = json_decode($_POST['additionalData']);&#10;        $arraysend      = array($upd_array);&#10;    }&#10;&#10;    $this-&gt;getCdbhelper()-&gt;trans_begin();&#10;&#10;    // shipping (main form data.)&#10;    $error = $this-&gt;mainmodel-&gt;updateGridData($arraysend);&#10;    if ($error != 'OK') {&#10;        $this-&gt;getCdbhelper()-&gt;trans_rollback();&#10;        $msg = '{&quot;status&quot;:' . json_encode($error) . ', &quot;rs&quot;: {} }';&#10;        echo($msg);&#10;        return;&#10;    }&#10;&#10;    // shipping requesters. (Speical field that has multi value: need to json_decode() the passed data.)  &#10;    $error = $this-&gt;requesters_model-&gt;updateGridData(json_decode($upd_array-&gt;ds_requesters_update));&#10;    if ($error != 'OK') {&#10;        $this-&gt;getCdbhelper()-&gt;trans_rollback();&#10;        $msg = '{&quot;status&quot;:' . json_encode($error) . ', &quot;rs&quot;: {} }';&#10;        echo($msg);&#10;        return;&#10;    }&#10;&#10;    // shipping cost (Grid: first bind the grid to form), use:&#10;    // thisObj.Form.addGridToControl('gridShippingCost');&#10;    $error = $this-&gt;cost_model-&gt;updateGridData($additionalData-&gt;gridShippingCost);&#10;    if ($error != 'OK') {&#10;        $this-&gt;getCdbhelper()-&gt;trans_rollback();&#10;        $msg = '{&quot;status&quot;:' . json_encode($error) . ', &quot;rs&quot;: {} }';&#10;        echo($msg);&#10;        return;&#10;    }&#10;&#10;    $this-&gt;getCdbhelper()-&gt;trans_commit();&#10;    $this-&gt;getCdbhelper()-&gt;trans_end();&#10;&#10;    $retResult = $this-&gt;mainmodel-&gt;retRetrieveGridJsonForm($arraysend[0]-&gt;recid);&#10;&#10;    $data = $this-&gt;womodel-&gt;retRetrieveGridJson(&quot;WHERE tr.\&quot;TEST_REQUEST_WORK_ORDER\&quot;.cd_test_request = {$arraysend[0]-&gt;recid}&quot;, &quot;ORDER BY nr_work_order&quot;);&#10;&#10;    $tableinfo = $this-&gt;docrep-&gt;getTableInfo(11, false);&#10;    $aattach = json_encode($this-&gt;docrep-&gt;retSQLArray(&quot; AND cd_test_request = {$arraysend[0]-&gt;recid}&quot;, $orderby = 'ORDER BY dt_record desc', $tableinfo), JSON_NUMERIC_CHECK);&#10;&#10;    // return comments for the &quot;afterupdate&quot;&#10;    $comments = $this-&gt;tr_comments_model-&gt;retRetrieveGridJson(&quot;WHERE cd_test_request = {$arraysend[0]-&gt;recid}&quot;, &quot;ORDER BY 1 DESC&quot;);&#10;&#10;    $msg = '{&quot;status&quot;:' . json_encode($error) . ', &quot;rs&quot;:' . $retResult . ', &quot;wo&quot;: ' . $data . ', &quot;attach&quot;:' . $aattach . ', &quot;comments&quot;:' .&#10;        $comments. '}';&#10;&#10;    echo $msg;&#10;}" description="重写 updateForm 方法" toReformat="false" toShortenFQNames="true">
    <context>
      <option name="PHP Class Member" value="true" />
      <option name="PHP Expression" value="true" />
      <option name="PHP Statement" value="true" />
    </context>
  </template>
  <template name="t-c-updateGrid" value="public function updateDataJson()&#10;{&#10;    $msg = '';&#10;&#10;    $upd_array = json_decode($_POST['upd']);&#10;    $retResultset = 'N';&#10;&#10;    if (isset($_POST['retResultSet'])) {&#10;        $retResultset = $_POST['retResultSet'];&#10;    }&#10;    $jsonMapping = '';&#10;    if (isset($_POST['jsonMapping'])) {&#10;        $jsonMapping = $_POST['jsonMapping'];&#10;    }&#10;&#10;    $this-&gt;cdbhelper-&gt;trans_begin();&#10;&#10;    // main fields update&#10;    $error = $this-&gt;mainmodel-&gt;updateGridData($upd_array);&#10;    if ($error != 'OK') {&#10;        $msg = '{&quot;status&quot;:' . json_encode($error) . ', &quot;rs&quot;:{}}';&#10;        $this-&gt;cdbhelper-&gt;trans_end();&#10;        echo $msg;&#10;        return;&#10;    }&#10;&#10;    // sourcing, multi users. delete &amp; add again.&#10;    foreach($upd_array as $key =&gt; $value) {&#10;        // if changed, remove the old data.&#10;        if($value-&gt;json_human_resource_sourcing) {&#10;&#10;            $delData = json_decode(json_encode($value-&gt;json_human_resource_sourcing),true);&#10;&#10;            $error = $this-&gt;supplier_buyer_model-&gt;deleteGridData($delData);&#10;            if ($error != 'OK') {&#10;                $this-&gt;getCdbhelper()-&gt;trans_rollback();&#10;                $msg = '{&quot;status&quot;:' . json_encode($error) . ', &quot;rs&quot;:{} }';&#10;                echo($msg);&#10;                return;&#10;            }&#10;        }&#10;&#10;        // insert new records.&#10;        if($value-&gt;cds_human_resource_sourcing) {&#10;            $uids    = explode(',', $value-&gt;cds_human_resource_sourcing);&#10;            $i           = -3; // recid &lt; -2 means &quot;new&quot;&#10;            $insData = [];&#10;&#10;            foreach ($uids as $uid) {&#10;                $insData[] = array(&#10;                    'recid' =&gt; $i,&#10;                    'cd_supplier' =&gt; $value-&gt;recid,&#10;                    'cd_human_resource' =&gt; $uid&#10;                );&#10;                $i--;&#10;            }&#10;            $error = $this-&gt;supplier_buyer_model-&gt;updateGridData($insData);&#10;        }&#10;    }&#10;&#10;    $this-&gt;cdbhelper-&gt;trans_commit();&#10;    $this-&gt;cdbhelper-&gt;trans_end();&#10;&#10;    $msg = '{&quot;status&quot;:' . json_encode($error);&#10;&#10;&#10;    $retResult = '{}';&#10;&#10;    if ($retResultset == 'Y' &amp;&amp; $error == 'OK') {&#10;        $neg = $this-&gt;mainmodel-&gt;getNewRecIdsNegative();&#10;        $x = implode(',', $neg);&#10;&#10;        $where = ' where ' . $this-&gt;mainmodel-&gt;pk_field . ' in (';&#10;        foreach ($upd_array as $value) {&#10;            $where = $where . $value-&gt;recid . ',';&#10;        }&#10;        if ($x != '') {&#10;            $where = $where . $x . ', ';&#10;        }&#10;        $where = $where . '-1 )';&#10;&#10;&#10;        $retResult = $this-&gt;mainmodel-&gt;retRetrieveGridJson($where, '', $jsonMapping);&#10;&#10;        $msg = $msg . ', &quot;rs&quot;: ' . $retResult;&#10;&#10;        if (count($neg) &gt; 0) {&#10;            $msg = $msg . ', &quot;negRS&quot;: ' . json_encode($neg);&#10;        }&#10;    }&#10;&#10;    $msg = $msg . '}';&#10;&#10;    //&#10;&#10;    echo $msg;&#10;}" description="重写 update Grid 方法" toReformat="false" toShortenFQNames="true">
    <context>
      <option name="PHP Class Member" value="true" />
      <option name="PHP Expression" value="true" />
      <option name="PHP Statement" value="true" />
    </context>
  </template>
  <template name="t-c-grid" value="$this-&gt;setGridParser();&#10;$grid-&gt;resetGrid();&#10;$grid-&gt;setForceDestroy(true);&#10;$grid-&gt;setSingleBarControl(true);&#10;$grid-&gt;addBreakToolbar();&#10;// $grid-&gt;addInsToolbar();&#10;// $grid-&gt;addDelToolbar();&#10;// $grid-&gt;addEditToolbar();&#10;// $grid-&gt;setInsertNegative(true);&#10;// $grid-&gt;showLineNumbers(!$perm_edit);&#10;$grid-&gt;setToolbarSearch(true);&#10;$grid-&gt;setDemandedColumns(array('cd_test_type'));&#10;$grid-&gt;setCRUDController(&quot;tr/test_request&quot;, false);&#10;$grid-&gt;addCRUDToolbar(true, false, false, false, true); //ret ins upd del hide&#10;&#10;$grid-&gt;addUserBtnToolbar('duplicate', 'Duplicate Selected TR', 'fa fa-files-o');&#10;&#10;$grid-&gt;addSpacerToolbar();&#10;$grid-&gt;addExportToolbar();&#10;&#10;$grid-&gt;addColumnKey();&#10;// add column 1&#10;// add column 2&#10;// ...&#10;&#10;$grid-&gt;setGridName(&quot;gridMyTR&quot;);&#10;$grid-&gt;setGridDivName('browse_grid_div');&#10;$grid-&gt;setGridToolbarFunction(&quot;dsMyTRObject.ToolBarClick&quot;);&#10;&#10;$data = $this-&gt;womodel-&gt;retRetrieveGridJson(&quot;WHERE tr.\&quot;TEST_REQUEST_WORK_ORDER\&quot;.cd_test_request = $code&quot;, &quot;ORDER BY nr_work_order&quot;);&#10;$grid-&gt;addRecords($data);&#10;&#10;$gridBrowse = $grid-&gt;retGrid();" description="生成 grid (普通)" toReformat="false" toShortenFQNames="true">
    <context>
      <option name="PHP Expression" value="true" />
      <option name="PHP Statement" value="true" />
    </context>
  </template>
</templateSet>